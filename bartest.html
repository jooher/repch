<html>
<head>
<style>canvas{display:block;}</style>
</head>
<body>
<canvas id="canvas" width="640" height="200" style="border:1px solid"></canvas>
<input  id="thresh" type="range" value="14" min="1" max="32" onchange="calc()"/>

<script>

const	
	threshEl	= document.getElementById("thresh"),
	canvasEl	= document.getElementsByTagName("canvas")[0],
	
	calc		= _=>{
	
		const	thresh=1<<threshEl.value, //14
			h2=document.createElement("h2");
			
		h2.textContent=thresh;
		document.body.insertBefore(h2,threshEl);
		
		Ys.forEach(Y=>{
				const canvas=canvasEl.cloneNode(true);
		
				document.body.insertBefore(canvas,threshEl);
				context=canvas.getContext('2d');
		
				drawY(Y,.1,"gray");
				
				const D=diff(Y);
				//drawY(D,.1,"rgba(0,0,100,1)");
				
				const	spans=Tune(D,60);
				drawW(spans,"rgba(255,0,0,.25)");
				
				const	b=Barcode(spans);
				drawT(b, 'black');
		});
		
	};

let	context;

const 
	Tune	=(D,tgt)=>{
	
		const	len	= D.length;
		
		let thresh=10000;
		
		while(1){
			const	W	= Spans(D,thresh),	
				count	= W.length-1,
				width	= len-W[0]-W[count],
				nu	= .8*width/(15*7),
				wu	= 6*nu;
				
			if(count<30)return; // no barcode
				
			let	ne = 0,
				we = 0,
				er = 0;
				
			for(let i=1;i<count;i++)
				er = (W[i]<nu) ? ++ne : (W[i]>wu) ? ++we : er;
			
			if(!er)return W;
			if(ne&&we)return; // not a barcode
			
			//threshold too low:
			if( count-ne>tgt )thresh*=1+ne;
			
			//threshold too high:
			if(we>0)thresh/=(1+.5*we);
			
		}
	
	},
	
	diff	= Y=>{
		const D=Array(Y.length);
		for(let x=Y.length-1;x>1;x--)D[x]=Y[x]-Y[x-1];
		return D;//.map(y=>y*y>thresh?y:0);
	},
	
	Spans	= (D,thresh)=>{
		
		const	spans	= Array(200),
			len	= D.length-1,
			FLAT	= len*5/(14*7),
			LEAST	= 40;
			
		let	x=0, count=0, d, w=0, dd=0;
		
		spans[0]=0;
			
		while(x<len){
			
			let	x0=x;
			
			while( ++x<len ){
				d=D[x];
				if(d*d>thresh)
					break;
			}				
			
			w += x-x0;
			
			let	u = d*dd<0,
				s=0,
				y=d;
				
			dd=d;
			x0 = x;
			
			while( ++x<len ){
				d=D[x];
				if( d*d<thresh || d*dd<0 )
					break;
				s+=(y+=d);
			}
			
			const a = s/y;
			
			w += a;
			
			if( w<FLAT )
				if(u)
					spans[++count] = w;
				else{
					spans[++count]=w/2;
					spans[++count]=w/2;
				}

			else
				if( count < LEAST )
					spans[count=0]=x0+a;
				else
					x=len;
			w = x-x0-a;
		}
		
		spans[++count]=w;
		
		return spans.slice(0,++count);
	},
	
	Barcode	=(function(){

		const
		
		EAN13	=(function(){
			
			const	EAN	={ "3211":"0", "2221":"1", "2122":"2", "1411":"3", "1132":"4", "1231":"5", "1114":"6", "1312":"7", "1213":"8", "3112":"9" },
				HED	={ "LLLLLL":"0", "LLGLGG":"1", "LLGGLG":"2", "LLGGGL":"3", "LGLLGG":"4", "LGGLLG":"5", "LGGGLL":"6", "LGLGLG":"7", "LGLGGL":"8", "LGGLGL":"9" },
				
				GRDS=3,
				DIGS=6*4,
				MIDS=5,
				BARS=GRDS+DIGS+MIDS+DIGS+GRDS,
				
			fit3	= (spans,o)=>{
				const	r0=spans[o+0]+2, r1=spans[o+1]+2, r2=spans[o+2]+2, half=(r0+r1+r2)*.5, quar=half*.5;
				return r0<half && r1<half && r2<half && r0>quar && r1>quar && r2>quar;
			},
			
			group	= (spans,o,count,left)=>{
				
				const
				WDTH = 7,
				THIN = 1,
				WIDE = 4,
				TRIES= 6;
				
				let	digits=[],
					p=[],
					parity="",
					unit=(spans[o+0]+spans[o+1]+spans[o+2]+spans[o+3])/WDTH;
						
				for(let dig=0; dig<count; dig++, o+=4 )
				{
					let	gap,
						tries=0,
						d;
					do{	
						const u=1.0/unit;
						gap=WDTH;
						for(let i=0; i<4; i++) gap-=(p[i]=Math.round(u*spans[o+i]));
						unit += gap * .1;
					}while(gap!=0 && tries++<TRIES);
					
					const t=p.map(n=> n<THIN?THIN:n>WIDE?WIDE:n);
					parity += (d=EAN[t.join("")]) ? 'L' : (left && (d=EAN[t.reverse().join("")])) ? 'G' : gap;
					digits.push(d||'*');
				}
				if(left)
					digits.unshift(HED[parity]||"*");
						
				return	digits;
			},
			
			verify	= digits=>{				
				const	decoded = digits.join(""),
					unclear	= decoded.match(/\*/g);
					
				//console.log("decoded: "+decoded);
				if(unclear)return digits.length-unclear.length;
				
				let	check	= 10-digits.pop(),//[12],//
					sum	= digits.reduce((s,n,i)=>s+(i%2?3*n:1*n),0);
				
				return (sum%10 == check)&&decoded;
			};

			return	spans=>{
			
				CheckSpans(spans);//.map(w=>Math.round(w)));
			
				const	HOPE=spans.length-BARS+4;
				let	left, right,decoded;
				for( let o=0; o <= HOPE; o++ )
					if(	fit3(spans,o)
						&& (left=group(spans,o+GRDS,6,true))
						//&& fit3(spans,o+GRDS+DIGS)
						&& (right=group(spans,o+GRDS+DIGS+MIDS,6,false))
						&& (decoded=verify(left.concat(right)))
					)return decoded;
			}
			
		})();
		

		return	spans=>EAN13(spans);//||EAN13(spans.reverse());
	})(),
	
	

Ys	= 
[
	[ 374,392,385,390,388,395,393,379,418,404,404,399,396,407,404,389,409,423,401,412,427,416,417,403,422,436,422,436,425,425,434,423,431,419,428,420,440,457,444,460,458,427,457,445,456,448,459,462,470,460,460,463,471,471,471,468,468,460,480,466,465,473,471,471,480,473,472,472,484,474,487,487,494,490,493,493,495,498,498,498,497,494,491,491,499,499,507,507,514,514,512,508,518,507,525,515,524,524,520,526,520,526,533,533,535,531,531,531,541,541,537,528,510,507,501,498,493,493,489,492,474,500,497,501,520,517,522,522,529,526,509,516,514,506,494,494,472,465,463,456,434,427,437,384,240,124,81,81,85,68,67,64,67,75,86,110,87,333,539,524,513,492,513,471,495,481,503,496,498,498,497,493,488,488,494,498,500,521,528,525,503,521,496,504,507,507,507,497,496,506,498,508,509,512,509,509,493,496,485,395,145,113,67,463,434,487,349,32,116,88,485,485,524,413,81,88,82,79,104,59,89,93,107,75,461,503,499,524,55,100,72,93,91,109,96,273,522,518,527,527,524,524,529,529,539,560,290,60,132,142,481,547,532,543,524,512,538,268,71,118,190,543,510,501,305,30,124,134,451,531,507,543,538,529,526,571,112,133,102,90,92,92,93,89,88,93,65,152,555,527,531,534,543,535,557,330,137,122,96,449,529,532,536,536,524,539,516,69,119,116,72,121,113,29,304,548,512,540,374,57,150,69,386,550,523,531,536,536,532,529,218,68,104,69,88,85,82,82,88,88,55,146,487,538,549,531,538,532,518,498,107,159,92,113,98,95,29,211,511,559,543,535,532,550,551,512,154,133,76,177,521,524,547,526,188,53,73,211,472,538,502,495,194,86,87,42,465,514,508,550,277,50,132,30,397,532,507,525,523,526,545,527,532,539,541,523,530,527,524,537,486,116,153,84,82,511,484,489,527,251,138,138,91,361,502,534,516,516,511,523,539,528,507,537,513,482,67,113,63,192,508,511,511,529,527,495,520,489,57,88,120,82,55,55,59,59,62,66,63,42,528,468,470,515,67,120,109,40,555,504,527,527,538,517,524,521,103,108,100,83,523,492,504,489,88,119,62,233,528,528,528,537,524,528,526,520,528,528,540,528,536,526,529,316,111,94,90,83,85,58,124,445,455,479,434,67,98,88,87,87,93,40,332,479,493,506,498,522,522,515,268,100,124,107,485,506,519,438,92,71,91,87,78,78,84,87,52,84,267,511,526,530,531,525,516,527,98,140,130,85,454,430,448,504,126,84,119,73,526,495,511,507,489,510,494,494,481,508,500,479,461,464,495,485,478,474,480,477,462,475,456,469,429,453,226,163,153,146,148,138,129,150,131,131,170,186,238,319,324,342,337,376,366,369,366,363,367,367,367,364,355,348,338,348,325,322,340,322,329,336,323,317,317,317,312,315,315,319,312,312 ],
	[ 255,266,252,260,237,237,243,233,231,239,250,236,239,242,244,244,245,245,233,237,264,260,258,261,265,265,278,268,255,245,215,239,248,255,261,251,284,256,280,276,262,276,274,277,293,293,283,283,291,295,285,288,283,262,274,295,307,324,306,298,329,321,298,323,317,296,300,307,313,319,308,329,338,341,346,352,358,326,344,341,339,378,357,345,367,364,362,351,350,354,365,377,378,371,368,365,364,389,395,391,409,382,389,396,409,381,396,403,416,408,406,438,459,420,435,421,441,445,451,447,434,403,404,407,420,432,463,418,435,431,447,436,449,461,447,465,473,445,466,459,472,475,471,454,463,484,464,477,473,491,495,491,483,493,500,500,505,497,499,485,490,507,496,511,496,499,499,507,502,541,534,531,520,532,512,530,548,531,490,527,560,560,549,563,566,556,560,560,558,558,566,555,556,562,564,568,555,562,551,565,564,578,580,586,594,590,604,604,605,602,593,593,610,610,621,609,617,617,624,628,622,615,615,615,617,635,637,640,642,646,637,643,642,648,650,643,649,649,661,665,678,674,683,679,671,675,676,676,682,679,682,688,694,683,690,703,717,721,713,710,704,701,712,706,715,712,710,710,716,712,722,718,661,591,566,566,568,544,565,558,557,561,565,554,569,566,572,559,554,546,551,530,308,395,528,465,318,485,515,422,183,214,226,211,503,554,430,253,266,346,522,591,569,569,572,488,369,543,563,567,478,303,414,555,366,290,477,589,569,520,304,278,259,238,220,339,574,558,563,389,397,547,523,538,468,255,289,289,532,558,425,284,557,557,570,549,270,295,240,261,270,473,573,559,562,339,278,310,390,585,570,565,455,344,443,573,463,352,484,631,429,399,607,680,467,464,681,702,694,694,695,689,688,568,402,534,644,497,404,606,657,665,653,661,526,393,512,659,647,668,519,306,296,289,289,265,639,549,341,383,670,670,680,502,476,673,645,429,540,663,646,653,654,654,650,674,290,293,313,337,609,487,336,326,333,592,633,619,597,304,323,581,506,266,288,267,247,208,477,624,626,639,411,317,571,540,318,294,626,620,622,622,623,618,627,627,635,650,653,660,675,678,687,690,680,680,676,672,675,669,673,670,670,678,672,672,661,661,650,650,650,645,651,638,634,637,639,642,643,640,622,622,616,613,589,602,592,592,606,606,601,583,585,578,571,563,573,580,572,589,587,574,569,572,551,525,540,530,530,524,545,566,548,545,528,522,517,514,515,494,494,487,501,498,502,474,440,495,458,451,478,481,431,446,464,467,472,472,479,461,460,453,427,441,405,399,426,408,408,408,423,428,439,418,380,390,372,389,397,401,391,385,366,390,364,368,398,377,406,398,399,389,378,378,381,371,349,345,350,346,336,336,362,348,343,351,340,316,344,337,330,335,334,323,340,343,323,337,312,337,297,331,305,301,312,318,319,319,330,285 ]
],
//Y	= Ys[1],
//D	= [ 0,18,-7,5,-2,7,-2,-14,39,-14,0,-5,-3,11,-3,-15,20,14,-22,11,15,-11,1,-14,19,14,-14,14,-11,0,9,-11,8,-12,9,-8,20,17,-13,16,-2,-31,30,-12,11,-8,11,3,8,-10,0,3,8,0,0,-3,0,-8,20,-14,-1,8,-2,0,9,-7,-1,0,12,-10,13,0,7,-4,3,0,2,3,0,0,-1,-3,-3,0,8,0,8,0,7,0,-2,-4,10,-11,18,-10,9,0,-4,6,-6,6,7,0,2,-4,0,0,10,0,-4,-9,-18,-3,-6,-3,-5,0,-4,3,-18,26,-3,4,19,-3,5,0,7,-3,-17,7,-2,-8,-12,0,-22,-7,-2,-7,-22,-7,10,-53,-144,-116,-43,0,4,-17,-1,-3,3,8,11,24,-23,246,206,-15,-11,-21,21,-42,24,-14,22,-7,2,0,-1,-4,-5,0,6,4,2,21,7,-3,-22,18,-25,8,3,0,0,-10,-1,10,-8,10,1,3,-3,0,-16,3,-11,-90,-250,-32,-46,396,-29,53,-138,-317,84,-28,397,0,39,-111,-332,7,-6,-3,25,-45,30,4,14,-32,386,42,-4,25,-469,45,-28,21,-2,18,-13,177,249,-4,9,0,-3,0,5,0,10,21,-270,-230,72,10,339,66,-15,11,-19,-12,26,-270,-197,47,72,353,-33,-9,-196,-275,94,10,317,80,-24,36,-5,-9,-3,45,-459,21,-31,-12,2,0,1,-4,-1,5,-28,87,403,-28,4,3,9,-8,22,-227,-193,-15,-26,353,80,3,4,0,-12,15,-23,-447,50,-3,-44,49,-8,-84,275,244,-36,28,-166,-317,93,-81,317,164,-27,8,5,0,-4,-3,-311,-150,36,-35,19,-3,-3,0,6,0,-33,91,341,51,11,-18,7,-6,-14,-20,-391,52,-67,21,-15,-3,-66,182,300,48,-16,-8,-3,18,1,-39,-358,-21,-57,101,344,3,23,-21,-338,-135,20,138,261,66,-36,-7,-301,-108,1,-45,423,49,-6,42,-273,-227,82,-102,367,135,-25,18,-2,3,19,-18,5,7,2,-18,7,-3,-3,13,-51,-370,37,-69,-2,429,-27,5,38,-276,-113,0,-47,270,141,32,-18,0,-5,12,16,-11,-21,30,-24,-31,-415,46,-50,129,316,3,0,18,-2,-32,25,-31,-432,31,32,-38,-27,0,4,0,3,4,-3,-21,486,-60,2,45,-448,53,-11,-69,515,-51,23,0,11,-21,7,-3,-418,5,-8,-17,440,-31,12,-15,-401,31,-57,171,295,0,0,9,-13,4,-2,-6,8,0,12,-12,8,-10,3,-213,-205,-17,-4,-7,2,-27,66,321,10,24,-45,-367,31,-10,-1,0,6,-53,292,147,14,13,-8,24,0,-7,-247,-168,24,-17,378,21,13,-81,-346,-21,20,-4,-9,0,6,3,-35,32,183,244,15,4,1,-6,-9,11,-429,42,-10,-45,369,-24,18,56,-378,-42,35,-46,453,-31,16,-4,-18,21,-16,0,-13,27,-8,-21,-18,3,31,-10,-7,-4,6,-3,-15,13,-19,13,-40,24,-227,-63,-10,-7,2,-10,-9,21,-19,0,39,16,52,81,5,18,-5,39,-10,3,-3,-3,4,0,0,-3,-9,-7,-10,10,-23,-3,18,-18,7,7,-13,-6,0,0,-5,3,0,4,-7,0],
//W	= [30,4,3,9,3,24,2,2,4,3,8,2,9,4,3,8,2,6,4,7,16,2,2,4,4,7,2,2,2,2,10,3,3,5,2,2,11,2,3,2,3,2,2,16,2,2,2,2,2,2,3,2,3,5,2,2,7,2,5,2,7,2,8,2,8,2,2,3,2,3,3,8,4,8,12,5,2,3,2,2,2,2,7,3,2,10,7,4,2,4,5,2,2,2,2,3,2,2],
y0	= 100,
H	= 10,

drawY	= (Y,k,style)=>{
	context.beginPath();
	for(let x=0;x<Y.length;x++){
		context.moveTo(x+.5,y0);
		context.lineTo(x+.5,y0+Y[x]*k);
	}
	context.strokeStyle = style;			
	context.lineWidth = 1;
	context.stroke();
},

drawW = (W,style)=>{
	context.fillStyle = style;		
	let i=0,x=0;
	while(i<W.length){
		const a=W[i++], b=W[i++];
		context.fillRect(x+a, y0+25, b, 40);
		x+=a+b;
	}
},

drawT	= (T,style)=>{
	context.fillStyle = style;		
	context.fillText(T, 20, 20);
}
;
	

</script>



</body>
</html>
